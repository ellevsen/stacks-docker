services:

  traefik:
    image: traefik:latest
    command:
      # API / Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Ping (obrigatório para o healthcheck)
      - "--ping=true"

      # Provider Swarm
      - "--providers.swarm=true"
      - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
      - "--providers.swarm.exposedbydefault=false"

      # Entrypoints públicos
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"

      # Encoded chars (v3.6.7+): false = rejeitar para evitar split-view com backends não RFC 3986
      - "--entrypoints.web.http.encodedCharacters.allowEncodedSlash=false"
      - "--entrypoints.web.http.encodedCharacters.allowEncodedBackSlash=false"
      - "--entrypoints.web.http.encodedCharacters.allowEncodedNullCharacter=false"
      - "--entrypoints.websecure.http.encodedCharacters.allowEncodedSlash=false"
      - "--entrypoints.websecure.http.encodedCharacters.allowEncodedBackSlash=false"
      - "--entrypoints.websecure.http.encodedCharacters.allowEncodedNullCharacter=false"

      # TLS / Let's Encrypt
      - "--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencryptresolver.acme.email=caio@caiov.dev"
      - "--certificatesresolvers.letsencryptresolver.acme.storage=/etc/traefik/acme/acme.json"

      # LOGS (CrowdSec)
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"

      # File provider: middlewares globais (rate-limit, security-headers) carregados antes do Swarm
      - "--providers.file.filename=/etc/traefik/dynamic/dynamic.yml"
      - "--providers.file.watch=true"

    configs:
      - source: traefik_global_middlewares
        target: /etc/traefik/dynamic/dynamic.yml

    volumes:
      - vol_certificates:/etc/traefik/acme
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vol_traefik_logs:/var/log/traefik

    networks:
      - swarm_public

    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", '--ping']
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 15s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    security_opt:
      - no-new-privileges:true

    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 256M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=swarm_public"

        # --- Router Dashboard (doc: PathPrefix /api e /dashboard obrigatórios; entrypoint websecure = HTTPS 443) ---
        - "traefik.http.routers.traefik-dashboard.rule=Host(`${DASHBOARD_DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
        - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
        - "traefik.http.routers.traefik-dashboard.tls=true"
        - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.traefik-dashboard.service=api@internal"
        # Swarm exige port no serviço; api@internal não tem backend real — dummy port (doc Traefik)
        - "traefik.http.services.traefik-traefik.loadbalancer.server.port=9999"

        # Middlewares: CrowdSec -> Auth -> Headers@file -> RateLimit@file
        - "traefik.http.routers.traefik-dashboard.middlewares=crowdsec-bouncer,traefik-auth,security-headers@file,rate-limit@file"

        # --- MIDDLEWARES LOCAIS (só dashboard) ---
        #- "traefik.http.middlewares.traefik-auth.basicauth.users=caio:$$apr1$$ll89czOq$$oNIAsXgF2NZfrZp0JHZN2/"

  # --- CrowdSec Agent ---
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    environment:
      COLLECTIONS: "crowdsecurity/traefik"
      GID: "${GID-1000}"
    volumes:
      - vol_traefik_logs:/var/log/traefik:ro
      - vol_crowdsec_db:/var/lib/crowdsec/data
      - vol_crowdsec_config:/etc/crowdsec
    networks:
      - swarm_public

    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    security_opt:
      - no-new-privileges:true

    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5

  # --- CrowdSec Bouncer (Traefik Middleware) ---
  crowdsec-bouncer:
    image: fbonalair/traefik-crowdsec-bouncer:latest
    environment:
      CROWDSEC_AGENT_HOST: crowdsec:8080
      GIN_MODE: release
      CROWDSEC_BOUNCER_API_KEY: ${CROWDSEC_BOUNCER_API_KEY}
    networks:
      - swarm_public

    read_only: true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    security_opt:
      - no-new-privileges:true

    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=swarm_public"
        # Middleware 'crowdsec-bouncer'
        - "traefik.http.middlewares.crowdsec-bouncer.forwardauth.address=http://crowdsec-bouncer:8080/api/v1/forwardAuth"
        - "traefik.http.middlewares.crowdsec-bouncer.forwardauth.trustForwardHeader=true"
        - "traefik.http.services.crowdsec-bouncer.loadbalancer.server.port=8080"

networks:
  swarm_public:
    external: true


configs:
  traefik_global_middlewares:
    external: true
    name: traefik_global_middlewares

volumes:
  vol_certificates:
    external: true
  vol_traefik_logs:
  vol_crowdsec_db:
  vol_crowdsec_config:
